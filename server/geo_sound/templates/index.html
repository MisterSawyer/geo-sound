<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Sounds of Poniat</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <link
      rel="icon"
      type="image/x-icon"
      href="{{ url_for('static', filename='favicon.ico') }}"
    />
    <link
      rel="icon"
      type="image/png"
      href="{{ url_for('static', filename='favicon.png') }}"
    />
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  </head>
  <body>
    <div class="header-bar">
      <button id="burger" class="burger-btn">â˜°</button>
      <h1 class="app-title">Sounds of Poniat</h1>
      <button id="add-btn" class="add-btn">ï¼‹</button>
      <button id="auth-btn" class="auth-btn">ðŸ”‘</button>
    </div>

    <div class="container">
      <!-- LEFT COLUMN -->
      <div class="left-panel">
        <h2>All Tracks</h2>
        {% for track in tracks %}
        <div
          class="track"
          id="track-{{ track.metadata.title or track.file }}"
          data-owner = "{{ track.metadata.owner }}"
          data-lat="{{ track.metadata.lat }}"
          data-lon="{{ track.metadata.lon }}"
          data-color="{{ track.metadata.color or '#3388ff' }}"
        >
          <div class="track-header">
            <h3
              id="title-{{ track.metadata.title or track.file }}"
              style="color: {{ track.metadata.color or '#000' }}"
            >
              {{ track.metadata.title or track.file }}
            </h3>

            <div class="track-actions">
              <!-- Edit button -->
              <button
                class="edit-btn"
                onclick="toggleEdit('{{ track.metadata.title or track.file }}')"
                title="Rename track"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  fill="currentColor"
                  viewBox="0 0 16 16"
                >
                  <path
                    d="M12.146.146a.5.5 0 0 1 .708 0l3 
                             3a.5.5 0 0 1 0 .708l-9.5 9.5a.5.5 
                             0 0 1-.168.11l-5 2a.5.5 0 0 
                             1-.65-.65l2-5a.5.5 0 0 
                             1 .11-.168l9.5-9.5zM11.207 
                             2L3 10.207V13h2.793L14 
                             4.793 11.207 2z"
                  />
                </svg>
              </button>
              <!-- Delete button -->
              <button
                class="delete-btn"
                onclick="deleteTrack('{{ track.metadata.title or track.file }}')"
                title="Delete track"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  fill="currentColor"
                  viewBox="0 0 16 16"
                >
                  <path
                    d="M5.5 5.5a.5.5 0 0 1 .5.5v7a.5.5 
             0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zm2.5.5a.5.5 
             0 0 1 1 0v7a.5.5 0 0 1-1 0v-7zm3 .5a.5.5 
             0 0 0-1 0v7a.5.5 0 0 0 1 0v-7z"
                  />
                  <path
                    fill-rule="evenodd"
                    d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 
             0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 
             0 0 1 0-2h3a1 1 0 0 1 1-1h4a1 1 0 
             1 1 1 1h3a1 1 0 0 1 1 1z"
                  />
                </svg>
              </button>
            </div>
          </div>

          {% if track.metadata.owner %}
          <p><strong>Owner:</strong> {{ track.metadata.owner }}</p>
          {% endif %} {% if track.metadata.lat and track.metadata.lon %}
          <p>
            <strong>Coordinates:</strong> {{ track.metadata.lat }}, {{
            track.metadata.lon }}
          </p>
          {% endif %}

          <audio class="plyr" controls>
            <source
              src="{{ url_for('sound.serve_sound', filename=track.file) }}"
              type="audio/{{ track.file.split('.')[-1] }}"
            />
          </audio>
        </div>
        {% endfor %}
      </div>

      <!-- RIGHT COLUMN -->
      <div class="right-panel">
        <div id="map"></div>
      </div>

      <!-- Login form, Hidden slide-down form -->
      <div class="auth-panel">
        <div class="auth-content">
        <h2>ðŸ”‘ Login / Register</h2>
        <form id="auth-form">
          <input type="text" id="username" placeholder="Username" required />
          <input
            type="password"
            id="password"
            placeholder="Password"
            required
          />
          <div class="auth-buttons">
            <button type="button" onclick="login()">Login</button>
            <button type="button" onclick="register()">Register</button>
          </div>
          <div id="auth-status"></div>
        </form>
        </div>
        <div class = "auth-logged-in">
        <div id="auth-logged-in-status"></div>
        <button id="logout-btn" type="button" onclick="logout()">Logout</button>
        </div>
        </div>
      </div>

      <!-- Add Track, Hidden slide-down form -->
      <div id="add-form-panel" class="add-form-panel">
        <form class="upload" enctype="multipart/form-data">
          <h2>Add New Track</h2>
          <input
            type="file"
            name="sound"
            accept="{{ config.FILE_ACCEPT }}"
            required
          />
          <input type="text" name="name" placeholder="Track Name" required />
          <input
            type="number"
            step="any"
            name="lat"
            placeholder="Latitude"
            required
          />
          <input
            type="number"
            step="any"
            name="lon"
            placeholder="Longitude"
            required
          />
          <label for="color">Pin Color:</label>
          <input type="color" name="color" id="color" value="#3388ff" />
          <button type="submit">Upload</button>
        </form>
      </div>
    </div>

    <p class="footer"> Made by Sawyer </p>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Map config -->
    <script>
      window.MAP = L.map('map', { 
        minZoom: 3, maxZoom: 20, zoomSnap: 0.25,
        wheelPxPerZoomLevel: 60, 
        zoomControl: false,})
    .setView([20, 0], 2);
      window.BOUNDS = L.latLngBounds([]);
      window.BASE_AUDIO_URL = "{{ url_for('sound.serve_sound', filename='') }}";
      window.BASE_API_UPLOAD_URL = "{{ url_for('api.upload') }}";
      window.BASE_API_DELETE_URL = "{{ url_for('api.delete', name='__NAME__') }}";
      window.BASE_API_RENAME_URL = "{{ url_for('api.rename', old_name='__OLD__') }}";
      window.BASE_API_COLOR_URL = "{{ url_for('api.update_color', name='__NAME__') }}";

       window.BASE_AUTH_REGISTER_URL = "{{ url_for('auth.register') }}";
       window.BASE_AUTH_LOGIN_URL = "{{ url_for('auth.login') }}";
       window.BASE_AUTH_ME_URL = "{{ url_for('auth.me') }}";
       window.BASE_AUTH_LOGOUT_URL = "{{ url_for('auth.logout') }}";

      window.TRACKS = {{ tracks|tojson }};
      window.MARKERS = {}
    </script>
    <!-- Local JS -->
    <script src="{{ url_for('static', filename='map.js') }}"></script>
    <script src="{{ url_for('static', filename='tracks.js') }}"></script>
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    <script src="{{ url_for('static', filename='player.js') }}"></script>
    <script src="{{ url_for('static', filename='auth.js') }}"></script>
  </body>
</html>
